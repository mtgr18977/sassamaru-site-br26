<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bench Rodada — Poisson + Elo (odds-like)</title>

  <!-- CSV parser (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="./model.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --muted:#9fb0e0;
      --text:#e9efff;
      --border:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --good:#2ee59d;
      --warn:#ffd37a;
      --bad:#ff7a7a;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:radial-gradient(1200px 600px at 15% 10%, rgba(122,162,255,.25), transparent 60%),
                 radial-gradient(1200px 600px at 85% 20%, rgba(46,229,157,.18), transparent 60%),
                 var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:28px 16px 56px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .card{
      background:linear-gradient(180deg, rgba(17,26,51,.92), rgba(17,26,51,.70));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
    }
    textarea, input[type="text"]{
      width:100%;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      font-family:var(--mono);
      font-size:13px;
      outline:none;
    }
    textarea{
      min-height:160px;
      resize:vertical;
      line-height:1.4;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    button{
      border:1px solid rgba(122,162,255,.35);
      background:linear-gradient(180deg, rgba(122,162,255,.25), rgba(122,162,255,.12));
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      transition:transform .05s ease, border-color .15s ease;
    }
    button:active{transform:translateY(1px)}
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .status b{color:var(--text)}
    .status .ok{color:var(--good)}
    .status .warn{color:var(--warn)}
    .status .bad{color:var(--bad)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      margin-top:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background:rgba(0,0,0,.25);
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .num{font-family:var(--mono); text-align:right}
    .mono{font-family:var(--mono)}
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      font-size:12px;
      font-weight:700;
    }
    .tag.home{border-color:rgba(46,229,157,.35)}
    .tag.draw{border-color:rgba(255,211,122,.35)}
    .tag.away{border-color:rgba(255,122,122,.35)}
    .footer-note{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .small{font-size:12px;color:var(--muted)}
    .danger{
      border-color:rgba(255,122,122,.35)!important;
      background:rgba(255,122,122,.08)!important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Bench Rodada — Poisson + Elo (odds-like)</h1>
        <p class="sub">
          Entrada: uma partida por linha no formato <span class="mono">Mandante x Visitante</span>.<br/>
          Saída: probabilidades 1X2 + odds com overround (margem) + gols esperados.
        </p>
      </div>
      <div class="pill" id="configPill"></div>
    </header>

    <div class="grid">
      <div class="card">
        <label for="fixtures">Rodada (uma por linha)</label>
        <textarea id="fixtures" spellcheck="false">flamengo x internacional
gremio x botafogo
bragantino x atletico mineiro
bahia x fluminense
santos x sao paulo
vasco x chapecoense
remo x mirassol
cruzeiro x coritiba
palmeiras x vitoria
athletico paranaense x corinthians</textarea>

        <div class="row" style="margin-top:12px;">
          <button id="runBtn" disabled>Rodar simulação</button>
          <span class="pill" id="modelState">Carregando dataset…</span>
        </div>

        <div class="status" id="status"></div>
        <div class="footer-note">
          <b>Como hospedar:</b> coloque este arquivo no seu servidor e deixe o CSV no mesmo diretório com o nome configurado abaixo.
          Se der erro de CORS/404, ajuste <span class="mono">CSV_PATH</span>.
        </div>
      </div>

      <div class="card">
        <label>Config do Modelo</label>
        <div class="small mono" id="cfg"></div>
        <div class="footer-note">
          <b>Notas:</b>
          <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted);">
            <li>Mando fica somente no Poisson (evita dupla contagem).</li>
            <li>Elo ajusta o λ via <span class="mono">exp(±adj)</span> com clamp.</li>
            <li>Forma recente ajusta λ com base nos últimos jogos (ataque/defesa).</li>
            <li>Dixon–Coles simplificado ajusta empates baixos (0–0, 1–1, 1–0, 0–1).</li>
            <li>Odds aplicam overround simples: <span class="mono">p_market = p * (1+m)</span>.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row" style="justify-content:space-between;">
        <div class="mono" style="font-weight:700;">Resultados</div>
        <div class="small" id="meta"></div>
      </div>

      <div style="overflow:auto; margin-top:8px;">
        <table id="outTable" aria-label="Resultados">
          <thead>
            <tr>
              <th>Mandante</th>
              <th>Visitante</th>
              <th class="num">Gols M</th>
              <th class="num">Gols V</th>
              <th class="num">P(M)%</th>
              <th class="num">P(E)%</th>
              <th class="num">P(V)%</th>
              <th class="num">Odd M</th>
              <th class="num">Odd E</th>
              <th class="num">Odd V</th>
              <th>Palpite</th>
            </tr>
          </thead>
          <tbody id="outBody">
            <tr><td colspan="11" class="small">Carregue o modelo e clique em “Rodar simulação”.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const Model = window.BenchModel;
const {
  CONFIG,
  buildModel,
  predictMatch,
} = Model;
let MODEL = null;

/** =========================
 *  UI
 *  ========================= */
const $ = (id) => document.getElementById(id);
const runBtn = $("runBtn");
const modelState = $("modelState");
const statusEl = $("status");
const outBody = $("outBody");
const metaEl = $("meta");
const cfgEl = $("cfg");
const configPill = $("configPill");

function setStatus(html){
  statusEl.innerHTML = html;
}

function setModelPill(text, cls){
  modelState.textContent = text;
  modelState.classList.remove("danger");
  if (cls === "danger") modelState.classList.add("danger");
}

function formatPct(x){
  return (x*100).toFixed(1);
}
function formatNum(x, d=2){
  return Number(x).toFixed(d);
}
function formatOdd(x){
  return Number(x).toFixed(2);
}

function renderRows(rows){
  outBody.innerHTML = "";
  for (const r of rows){
    const tagClass = r.pick === "Mandante" ? "home" : (r.pick === "Empate" ? "draw" : "away");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.home.replace(/\b\w/g, c => c.toUpperCase())}</td>
      <td class="mono">${r.away.replace(/\b\w/g, c => c.toUpperCase())}</td>
      <td class="num">${formatNum(r.lamH, 2)}</td>
      <td class="num">${formatNum(r.lamA, 2)}</td>
      <td class="num">${formatPct(r.pH)}</td>
      <td class="num">${formatPct(r.pD)}</td>
      <td class="num">${formatPct(r.pA)}</td>
      <td class="num">${formatOdd(r.oh)}</td>
      <td class="num">${formatOdd(r.od)}</td>
      <td class="num">${formatOdd(r.oa)}</td>
      <td><span class="tag ${tagClass}">${r.pick}</span></td>
    `;
    outBody.appendChild(tr);
  }
}

function parseFixtures(text){
  const lines = text.split("\n").map(s => s.trim()).filter(Boolean);
  const fixtures = [];
  for (const line of lines){
    // aceita "a x b", "a vs b", "a - b"
    const m = line.match(/^(.+?)\s*(?:x|vs|v|—|-)\s*(.+)$/i);
    if (!m) continue;
    fixtures.push([m[1].trim(), m[2].trim()]);
  }
  return fixtures;
}

runBtn.addEventListener("click", () => {
  if (!MODEL) return;

  const fixtures = parseFixtures($("fixtures").value);
  if (!fixtures.length){
    setStatus(`<span class="bad">Nenhuma partida válida.</span> Use “mandante x visitante” (uma por linha).`);
    return;
  }

  const t0 = performance.now();
  const results = fixtures.map(([h,a]) => predictMatch(h,a, MODEL));
  const t1 = performance.now();

  renderRows(results);

  metaEl.textContent = `${results.length} jogos • ${(t1 - t0).toFixed(0)} ms`;
  setStatus(`<span class="ok">OK</span> — simulação concluída.`);
});

/** =========================
 *  Load CSV & init
 *  ========================= */
function renderConfig(){
  configPill.textContent = `ρ=${CONFIG.DC_RHO} • γ=${CONFIG.ELO_GAMMA} • forma=${CONFIG.FORM_MATCHES}j • overround=${(CONFIG.OVERROUND*100).toFixed(1)}%`;
  cfgEl.textContent =
`CSV_PATH: ${CONFIG.CSV_PATH}
colunas: data=${CONFIG.DATE_COL} | mandante=${CONFIG.HOME_TEAM_COL} | visitante=${CONFIG.AWAY_TEAM_COL} | gols_m=${CONFIG.HOME_GOALS_COL} | gols_v=${CONFIG.AWAY_GOALS_COL}

Half-life: Elo=${CONFIG.HALF_LIFE_ELO_DAYS}d | Poisson=${CONFIG.HALF_LIFE_POISSON_DAYS}d
min pesos: Elo=${CONFIG.MIN_W_ELO} | Poi=${CONFIG.MIN_W_POI}

Elo: inicial=${CONFIG.ELO_INITIAL} | Kbase=${CONFIG.ELO_K_BASE} | reset/ano α=${CONFIG.SEASON_RESET_ALPHA}
Elo→λ: γ=${CONFIG.ELO_GAMMA} | clamp=±${CONFIG.ELO_LAMBDA_CLAMP}

Forma recente: jogos=${CONFIG.FORM_MATCHES} | half-life=${CONFIG.HALF_LIFE_FORM_DAYS}d | min_w=${CONFIG.MIN_W_FORM}
Forma λ clamp: ${CONFIG.FORM_FACTOR_MIN}–${CONFIG.FORM_FACTOR_MAX}

Dixon–Coles: ρ=${CONFIG.DC_RHO}
Odds: overround=${(CONFIG.OVERROUND*100).toFixed(1)}%`;
}

async function loadCSV(){
  renderConfig();
  setModelPill("Carregando dataset…");
  setStatus(`Carregando <b>${CONFIG.CSV_PATH}</b>…`);

  const res = await fetch(CONFIG.CSV_PATH, {cache:"no-store"});
  if (!res.ok){
    throw new Error(`Falha ao carregar CSV (${res.status}). Verifique CSV_PATH e se o arquivo está acessível.`);
  }
  const text = await res.text();

  const parsed = await new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: (r) => resolve(r.data),
      error: (e) => reject(e)
    });
  });

  // valida colunas
  const sample = parsed[0] || {};
  const required = [
    CONFIG.DATE_COL,
    CONFIG.HOME_TEAM_COL,
    CONFIG.AWAY_TEAM_COL,
    CONFIG.HOME_GOALS_COL,
    CONFIG.AWAY_GOALS_COL,
  ];
  const missing = required.filter(c => !(c in sample));
  if (missing.length){
    throw new Error(`CSV não contém colunas necessárias: ${missing.join(", ")}.`);
  }

  setStatus(`Construindo modelo a partir de <b>${parsed.length}</b> linhas…`);
  const t0 = performance.now();
  MODEL = buildModel(parsed);
  const t1 = performance.now();

  runBtn.disabled = false;
  setModelPill(`Modelo pronto • ${MODEL.teamCount} times`, "");
  metaEl.textContent = `dataset: ${MODEL.parsedCount} jogos • build: ${(t1 - t0).toFixed(0)} ms`;
  setStatus(
    `<span class="ok">OK</span> — modelo construído.
     Ref: <b>${MODEL.refDate.toISOString().slice(0,10)}</b> • médias liga: casa=${MODEL.leagueHomeAvg.toFixed(2)} fora=${MODEL.leagueAwayAvg.toFixed(2)}`
  );
}

loadCSV().catch(err => {
  console.error(err);
  runBtn.disabled = true;
  setModelPill("Erro ao carregar", "danger");
  setStatus(`<span class="bad">Erro:</span> ${String(err.message || err)}`);
});
</script>
</body>
</html>
